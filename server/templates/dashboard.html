{% extends "layout.html" %}
{% block title %}Dashboard - TekPossible Monitor{% endblock %}

{% block head_extra %}
    {{ super() }}
    {# Chart.js and Litepicker are assumed to be in layout.html or loaded globally #}
{% endblock %}

{% block content %}
<div id="dashboard-page" class="page">
    <div class="page-header">
        <h1 class="page-title">Dashboard</h1>
    </div>

    <div class="dashboard-filters">
        <div class="btn-group">
            <a href="{{ url_for('dashboard.view_dashboard', period='day', employee_id=selected_employee_id if selected_employee_id else 'all') }}" class="btn btn-secondary btn-sm {% if selected_period == 'day' %}active{% endif %}">Day</a>
            <a href="{{ url_for('dashboard.view_dashboard', period='week', employee_id=selected_employee_id if selected_employee_id else 'all') }}" class="btn btn-secondary btn-sm {% if selected_period == 'week' %}active{% endif %}">Week</a>
            <a href="{{ url_for('dashboard.view_dashboard', period='month', employee_id=selected_employee_id if selected_employee_id else 'all') }}" class="btn btn-secondary btn-sm {% if selected_period == 'month' %}active{% endif %}">Month</a>
            <button type="button" class="btn btn-secondary btn-sm {% if selected_period == 'custom' %}active{% endif %}" id="dateRangePickerTriggerDashboard">Date Range</button>
        </div>
        <select class="form-control form-select-sm" id="employeeFilterSelectDashboard" name="employee_id" title="Filter dashboard by employee">
            <option value="all" {% if not selected_employee_id or selected_employee_id == 'all' %}selected{% endif %}>All Employees</option>
            {% for emp in filter_employees_list %}
                <option value="{{ emp.employee_id }}" {% if emp.employee_id == selected_employee_id %}selected{% endif %}>
                    {{ emp.display_name | default(emp.employee_id, true) }}
                </option>
            {% endfor %}
        </select>
        <span class="date-info">Showing: {{ start_date_str }} to {{ end_date_str }}</span>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><h4>Average Start Time</h4><p>{{ avg_start_time if avg_start_time != 'N/A' else '--:--' }}</p></div>
        <div class="stat-card"><h4>{{ team_working_time_label | default('Working Time') }}</h4><p>{{ team_working_time | default('--:--:--', true) }}</p></div>
        <div class="stat-card"><h4>Latest Activity Seen</h4><p>{{ avg_last_seen if avg_last_seen != 'N/A' else '--:--' }}</p></div>
        <div class="stat-card"><h4>Team Members</h4><p>{{ team_members_count | default('0', true) }}</p></div>
        <div class="stat-card"><h4>Tracked Members</h4><p>{{ tracked_members_count | default('0', true) }}</p></div>
    </div>

    <div class="dashboard-row">
        <div class="dashboard-col-left card chart-container">
            <h3 class="card-title">Top 5 websites & applications <i class="fas fa-info-circle info-icon" title="Total active time during selected period for {{ selected_employee_id or 'all employees' }}"></i></h3>
            <div style="display: flex; align-items: center; min-height: 180px;">
                 <canvas id="topSitesChart" style="max-width: 160px; max-height: 160px; margin: 0 auto 15px auto; display: block;"></canvas>
                <div class="chart-legend" style="flex-grow: 1; margin-left: 20px;">
                    <ul id="topSitesLegend">
                        {# This part is now correctly handled by JavaScript in scripts_extra if populated by JS,
                           or can be pre-rendered if top_websites is small enough and colors are managed.
                           For simplicity if JS populates, this Jinja loop is a fallback or initial state.
                        #}
                        {% if top_websites and top_websites|length > 0 %}
                            {% for site in top_websites %}
                            <li>
                                <span><span class="legend-color" style="background-color: #ccc;"></span>{{ site.name | truncate(25) }}</span> 
                                <span>{{ "{:0>2}:{:0>2}".format(site.duration // 60 % 60, site.duration % 60) if site.duration < 3600 else "{:0>2}:{:0>2}:{:0>2}".format(site.duration // 3600, site.duration // 60 % 60, site.duration % 60) }}</span>
                            </li>
                            {% endfor %}
                        {% else %}
                            <li class="text-muted small">No website/app data for this selection.</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="dashboard-col-right card work-hours-table">
            <h3 class="card-title">Work Hours (Total) <a href="#" class="table-header-icon" title="Download CSV (Not Implemented)" onclick="event.preventDefault(); alert('Download CSV feature not implemented yet.');"><i class="fas fa-download"></i></a></h3>
            <div class="table-container" style="padding:0; box-shadow: none; border:none;">
            <table>
                <thead><tr><th>Name</th><th>Man Days</th><th>Work Hours (Total)</th></tr></thead>
                <tbody>
                    {# CORRECTED JINJA SYNTAX HERE #}
                    {% if work_hours_data and work_hours_data|length > 0 %}
                        {% for item in work_hours_data %}
                        <tr><td>{{ item.name | truncate(25) }}</td><td>{{ item.man_days | default('0', true) }}</td><td>{{ item.work_hours | default('--:--:--', true) }}</td></tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="3" class="text-center text-muted" style="padding:20px;">No work hour data found for this period.</td></tr>
                    {% endif %}
                    {# PREVIOUSLY HAD AN EXTRA MISPLACED ENDFOR HERE #}
                </tbody>
            </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Litepicker for Dashboard
    const datePickerTriggerDashboard = document.getElementById('dateRangePickerTriggerDashboard');
    if (datePickerTriggerDashboard) {
        const picker = new Litepicker({
            element: datePickerTriggerDashboard,
            singleMode: false, numberOfMonths: 2, numberOfColumns: 2, format: 'YYYY-MM-DD',
            buttonText: {apply: 'Apply', cancel: 'Cancel', previousMonth: '<i class="fas fa-chevron-left"></i>', nextMonth: '<i class="fas fa-chevron-right"></i>', reset: '<i class="fas fa-undo"></i>'},
            {% if selected_period == 'custom' and start_date_str and end_date_str %}
            startDate: '{{ start_date_str }}',
            endDate: '{{ end_date_str }}',
            {% endif %}
            setup: (pickerInstance) => {
                pickerInstance.on('selected', (date1, date2) => {
                    if (date1 && date2) {
                        const startDate = date1.format('YYYY-MM-DD');
                        const endDate = date2.format('YYYY-MM-DD');
                        const currentEmployeeId = document.getElementById('employeeFilterSelectDashboard').value || 'all';
                        window.location.href = `{{ url_for('dashboard.view_dashboard') }}?period=custom&start=${startDate}&end=${endDate}&employee_id=${currentEmployeeId}`;
                    }
                });
            }
        });
    }

    // Employee Filter Change Handler for Dashboard
    const employeeSelectDashboard = document.getElementById('employeeFilterSelectDashboard');
    if (employeeSelectDashboard) {
        employeeSelectDashboard.addEventListener('change', function() {
            const selectedEmployee = this.value || 'all';
            const urlParams = new URLSearchParams(window.location.search);
            const period = urlParams.get('period') || 'day';
            const start = urlParams.get('start');
            const end = urlParams.get('end');

            let newUrl = `{{ url_for('dashboard.view_dashboard') }}?period=${period}&employee_id=${selectedEmployee}`;
            if (period === 'custom' && start && end) {
                newUrl += `&start=${start}&end=${end}`;
            }
            window.location.href = newUrl;
        });
    }

    // Chart.js for Top Sites
    const ctx = document.getElementById('topSitesChart');
    const topSitesLegendElement = document.getElementById('topSitesLegend');
    let topSitesData = [];

    try {
        const jsonData = {{ top_websites | tojson | safe }}; 
        if (jsonData && Array.isArray(jsonData)) { topSitesData = jsonData; }
    } catch (e) { console.error("Error processing top_websites JSON:", e); }

    const chartLabels = topSitesData.map(item => item.name && item.name.length > 20 ? item.name.substring(0, 18) + '...' : (item.name || 'Unknown'));
    const chartDataValues = topSitesData.map(item => item.duration || 0);
    const chartBackgroundColors = ['#4CAF50', '#2196F3', '#FFC107', '#E91E63', '#9c27b0', '#00bcd4', '#ff9800']; 

    if (ctx && topSitesData && topSitesData.length > 0) {
      if (window.topSitesChartInstance) { window.topSitesChartInstance.destroy(); }
      window.topSitesChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: { 
            labels: chartLabels, 
            datasets: [{ 
                label: 'Time Spent', 
                data: chartDataValues, 
                backgroundColor: chartBackgroundColors.slice(0, chartDataValues.length), 
                hoverOffset: 4,
                borderWidth: 1 
            }] 
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            cutout: '65%',
            plugins: { 
                legend: { display: false }, 
                tooltip: { 
                    callbacks: { 
                        label: function(c){
                            let l=c.label||'';
                            let v=c.raw||0;
                            let s=parseInt(v);
                            let h=Math.floor(s/3600);
                            let m=Math.floor((s%3600)/60);
                            let sec=s%60;
                            let t='';
                            if(h>0)t+=`${h}h `;
                            if(m>0||h>0)t+=`${m}m `;
                            t+=`${sec}s`;
                            return`${l}: ${t.trim()}`;
                        }
                    }
                }
            }
        }
      });
      
      if(topSitesLegendElement) {
          topSitesLegendElement.innerHTML = ''; 
          if (topSitesData.length > 0) {
            topSitesData.forEach((site, index) => {
                const color = chartBackgroundColors[index % chartBackgroundColors.length];
                const duration = site.duration || 0;
                const hours = Math.floor(duration / 3600);
                const minutes = Math.floor((duration % 3600) / 60);
                const seconds = duration % 60;
                let formattedTime = '';
                if (hours > 0) formattedTime += `${String(hours).padStart(2, '0')}:`;
                formattedTime += `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                topSitesLegendElement.innerHTML += `
                    <li>
                        <span><span class="legend-color" style="background-color: ${color};"></span>${site.name ? String(site.name).substring(0,25) : 'Unknown'}</span> 
                        <span>${formattedTime}</span>
                    </li>`;
            });
          } else {
             topSitesLegendElement.innerHTML = '<li class="text-muted small">No website/app data for this selection.</li>';
          }
      }

    } else if (ctx) { 
        const context = ctx.getContext('2d');
        context.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        context.textAlign = 'center'; context.textBaseline = 'middle'; context.fillStyle = '#6c757d'; context.font = "14px sans-serif";
        context.fillText("No data for chart", ctx.canvas.width / 2, ctx.canvas.height / 2);
        if(topSitesLegendElement) topSitesLegendElement.innerHTML = '<li class="text-muted small">No website/app data for chart.</li>';
    }
});
</script>
{% endblock %}