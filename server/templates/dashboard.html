{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}

{% block head_extra %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js" defer></script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard</h1>
    <div class="btn-toolbar mb-2 mb-md-0 align-items-center"> {# Use align-items-center for vertical alignment #}
        <div class="btn-group me-2">
            <a href="{{ url_for('dashboard.view_dashboard', period='day', employee_id=selected_employee_id if selected_employee_id else 'all') }}"
               class="btn btn-sm btn-outline-secondary {% if selected_period == 'day' %}active{% endif %}">Day</a>
            <a href="{{ url_for('dashboard.view_dashboard', period='week', employee_id=selected_employee_id if selected_employee_id else 'all') }}"
               class="btn btn-sm btn-outline-secondary {% if selected_period == 'week' %}active{% endif %}">Week</a>
            <a href="{{ url_for('dashboard.view_dashboard', period='month', employee_id=selected_employee_id if selected_employee_id else 'all') }}"
               class="btn btn-sm btn-outline-secondary {% if selected_period == 'month' %}active{% endif %}">Month</a>
            <button type="button" class="btn btn-sm btn-outline-secondary {% if selected_period == 'custom' %}active{% endif %}" id="dateRangePickerTrigger">Date Range</button>
        </div>
        <div class="btn-group me-3"> {# Employee Selector #}
            <select class="form-select form-select-sm" id="employeeFilterSelect" style="width: auto;" title="Filter dashboard by employee">
                <option value="all" {% if not selected_employee_id or selected_employee_id == 'all' %}selected{% endif %}>All Employees</option>
                {% for emp in filter_employees_list %}
                    <option value="{{ emp.employee_id }}" {% if emp.employee_id == selected_employee_id %}selected{% endif %}>
                        {{ emp.display_name | default(emp.employee_id, true) }}
                    </option>
                {% endfor %}
            </select>
        </div>
         <span class="text-muted small" title="Currently selected date range"> {# Removed ms-2, align-self-center as btn-toolbar handles alignment #}
             Showing: {{ start_date_str }} to {{ end_date_str }}
         </span>
    </div>
</div>

<!-- Top Stats Row -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center h-100"> {# Added h-100 for consistent height #}
            <div class="card-body d-flex flex-column"> {# Added d-flex for centering #}
                <h5 class="card-title text-muted">Average Start Time</h5>
                <p class="card-text fs-4 mt-auto">{{ avg_start_time if avg_start_time != 'N/A' else '--:--' }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center h-100">
            <div class="card-body d-flex flex-column">
                <h5 class="card-title text-muted">{{ team_working_time_label | default('Working Time', true) }}</h5>
                <p class="card-text fs-4 mt-auto">{{ team_working_time | default('--:--:--', true) }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
         <div class="card text-center h-100">
             <div class="card-body d-flex flex-column">
                 <h5 class="card-title text-muted">Latest Activity Seen</h5>
                 <p class="card-text fs-4 mt-auto">{{ avg_last_seen if avg_last_seen != 'N/A' else '--:--' }}</p>
             </div>
         </div>
     </div>
     <div class="col-md-3">
         <div class="row h-100">
             <div class="col-6 d-flex">
                 <div class="card text-center w-100 mb-2 mb-md-0"> {# w-100 and adjusted margin #}
                      <div class="card-body px-1 py-2 d-flex flex-column">
                           <h6 class="card-title text-muted small">Team Members</h6>
                           <p class="card-text fs-5 mt-auto">{{ team_members_count | default('0', true) }}</p>
                       </div>
                 </div>
             </div>
              <div class="col-6 d-flex">
                 <div class="card text-center w-100">
                      <div class="card-body px-1 py-2 d-flex flex-column">
                           <h6 class="card-title text-muted small">Tracked Members</h6>
                           <p class="card-text fs-5 mt-auto">{{ tracked_members_count | default('0', true) }}</p>
                       </div>
                 </div>
             </div>
         </div>
     </div>
</div>


<!-- Charts and Tables Row -->
<div class="row">
    <div class="col-md-6 mb-4"> {# Added mb-4 for spacing on small screens #}
        <div class="card h-100">
            <div class="card-header">
                Top 5 websites & applications
                 <i class="bi bi-info-circle float-end" title="Total active time during selected period for {{ selected_employee_id or 'all employees' }}"></i>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="topSitesChart" width="200" height="200"></canvas>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            {% for site in top_websites %}
                            <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                                <span title="{{ site.name }}">{{ site.name | truncate(25) }}</span>
                                <span class="badge bg-primary rounded-pill">{{ "{:0>2}:{:0>2}".format(site.duration // 60 % 60, site.duration % 60) if site.duration < 3600 else "{:0>2}:{:0>2}:{:0>2}".format(site.duration // 3600, site.duration // 60 % 60, site.duration % 60) }}</span>
                            </li>
                            {% else %}
                            <li class="list-group-item text-muted">No activity data found for this period.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card h-100">
             <div class="card-header">
                Work Hours (Total)
                <button class="btn btn-sm btn-outline-secondary float-end" title="Download CSV (Not Implemented)" disabled><i class="bi bi-download"></i></button>
            </div>
            <div class="card-body p-0">
                 <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th scope="col">Name</th>
                                <th scope="col" title="Unique days with activity in period">Man Days</th>
                                <th scope="col" title="Total work hours in period (HH:MM:SS)">Work Hours (Total)</th>
                            </tr>
                        </thead>
                        <tbody>
                             {% for item in work_hours_data %}
                             <tr>
                                 <td title="{{ item.name }}">{{ item.name | truncate(25) }}</td>
                                 <td>{{ item.man_days | default('0', true) }}</td>
                                 <td>{{ item.work_hours | default('--:--:--', true) }}</td>
                             </tr>
                             {% else %}
                             <tr>
                                <td colspan="3" class="text-center text-muted">No work hour data found for this period.</td>
                             </tr>
                             {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<button class="btn btn-danger position-fixed bottom-0 end-0 m-3 rounded-pill" style="z-index: 1050;" onclick="alert('Help feature not implemented yet.');">
    <i class="bi bi-question-circle-fill"></i> Help
</button>
{% endblock %}

{% block scripts_extra %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const datePickerTrigger = document.getElementById('dateRangePickerTrigger');
    if (datePickerTrigger) {
        const picker = new Litepicker({
            element: datePickerTrigger,
            singleMode: false, numberOfMonths: 2, numberOfColumns: 2, format: 'YYYY-MM-DD',
            buttonText: {apply: 'Apply', cancel: 'Cancel', previousMonth: '<i class="bi bi-chevron-left"></i>', nextMonth: '<i class="bi bi-chevron-right"></i>', reset: '<i class="bi bi-arrow-counterclockwise"></i>'},
            {% if selected_period == 'custom' and start_date_str and end_date_str %}
            startDate: '{{ start_date_str }}',
            endDate: '{{ end_date_str }}',
            {% endif %}
            setup: (pickerInstance) => {
                pickerInstance.on('selected', (date1, date2) => {
                    if (date1 && date2) {
                        const startDate = date1.format('YYYY-MM-DD');
                        const endDate = date2.format('YYYY-MM-DD');
                        const currentEmployeeId = document.getElementById('employeeFilterSelect').value || 'all';
                        window.location.href = `{{ url_for('dashboard.view_dashboard') }}?period=custom&start=${startDate}&end=${endDate}&employee_id=${currentEmployeeId}`;
                    }
                });
            }
        });
    }

    const employeeSelect = document.getElementById('employeeFilterSelect');
    if (employeeSelect) {
        employeeSelect.addEventListener('change', function() {
            const selectedEmployee = this.value || 'all';
            const urlParams = new URLSearchParams(window.location.search);
            const period = urlParams.get('period') || 'day';
            const start = urlParams.get('start');
            const end = urlParams.get('end');

            let newUrl = `{{ url_for('dashboard.view_dashboard') }}?period=${period}&employee_id=${selectedEmployee}`;
            if (period === 'custom' && start && end) {
                newUrl += `&start=${start}&end=${end}`;
            }
            window.location.href = newUrl;
        });
    }

    const ctx = document.getElementById('topSitesChart');
    let topSitesData = [];
    try {
        const jsonData = '{{ top_websites | tojson | safe }}';
        if (jsonData) { topSitesData = JSON.parse(jsonData); }
    } catch (e) { console.error("Error parsing top_websites JSON:", e); }

    const labels = topSitesData.map(item => item.name && item.name.length > 20 ? item.name.substring(0, 18) + '...' : (item.name || 'Unknown'));
    const dataValues = topSitesData.map(item => item.duration || 0);
    const backgroundColors = ['rgba(25, 135, 84, 0.8)','rgba(13, 110, 253, 0.8)','rgba(108, 117, 125, 0.8)','rgba(255, 193, 7, 0.8)','rgba(220, 53, 69, 0.8)'];

    if (ctx && topSitesData && topSitesData.length > 0) {
      if (window.topSitesChartInstance) { window.topSitesChartInstance.destroy(); }
      window.topSitesChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: labels, datasets: [{ label: 'Time Spent (seconds)', data: dataValues, backgroundColor: backgroundColors.slice(0, dataValues.length), hoverOffset: 4 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(c){let l=c.label||'',v=c.raw||0,s=parseInt(v),h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60,t='';if(h>0)t+=`${h}h `;if(m>0||h>0)t+=`${m}m `;t+=`${sec}s`;return`${l}: ${t.trim()}`;}}}}}
      });
    } else if (ctx) {
        const context = ctx.getContext('2d');
        context.clearRect(0, 0, ctx.width, ctx.height);
        context.textAlign = 'center'; context.textBaseline = 'middle'; context.fillStyle = '#6c757d'; context.font = "14px sans-serif";
        context.fillText("No website/app data for this selection", ctx.canvas.width / 2, ctx.canvas.height / 2);
    }
});
</script>
{% endblock %}