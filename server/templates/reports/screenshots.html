{% extends "layout.html" %}
{% block title %}Screenshot Report{% endblock %}

{% block head_extra %}
{{ super() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js" defer></script>
<style>
    .screenshot-gallery .card { transition: transform .2s; }
    .screenshot-gallery .card:hover { transform: scale(1.03); }
    .screenshot-gallery .card-img-top { width: 100%; height: 150px; object-fit: cover; cursor: pointer; }
    .screenshot-gallery .col-lg-2 { margin-bottom: 1rem; } /* Adjust grid column for more/less thumbnails per row */
    .modal-xl { max-width: 90%; } /* Make modal larger */
    .modal-body img { max-width: 100%; height: auto; max-height: 80vh; /* Limit image height in modal */ }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Screenshot Report</h1>
    <a href="{{ url_for('reports.index') }}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left-circle me-1"></i> Back to Reports List
    </a>
</div>

<form method="GET" action="{{ url_for('reports.screenshot_report') }}" class="mb-4 p-3 border rounded bg-light">
    <div class="row g-3 align-items-end">
        <div class="col-md-4">
            <label for="employee_id_ss" class="form-label">Select Employee:</label>
            <select name="employee_id" id="employee_id_ss" class="form-select" required>
                <option value="" {% if not selected_employee_id %}selected{% endif %} disabled>-- Select an Employee --</option>
                {% for emp in employees %}
                <option value="{{ emp.employee_id }}" {% if emp.employee_id == selected_employee_id %}selected{% endif %}>
                    {{ emp.display_name }} ({{ emp.employee_id }})
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="start_date_picker_ss" class="form-label">Start Date:</label>
            <input type="text" class="form-control" id="start_date_picker_ss" name="start_date" value="{{ start_date_str }}">
        </div>
        <div class="col-md-3">
            <label for="end_date_picker_ss" class="form-label">End Date:</label>
            <input type="text" class="form-control" id="end_date_picker_ss" name="end_date" value="{{ end_date_str }}">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">View Screenshots</button>
        </div>
    </div>
</form>

{% if selected_employee_id %}
    {% if screenshots %}
    <div class="row screenshot-gallery g-3">
        {% for ss_log in screenshots %}
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 col-6"> {# More responsive grid #}
            <div class="card h-100 shadow-sm">
                <img src="{{ url_for('reports.view_screenshot', filename=ss_log.screenshot_path) }}"
                     alt="Screenshot from {{ ss_log.timestamp.strftime('%Y-%m-%d %H:%M') }}"
                     class="card-img-top"
                     data-bs-toggle="modal" data-bs-target="#screenshotModal"
                     data-img-src="{{ url_for('reports.view_screenshot', filename=ss_log.screenshot_path) }}"
                     data-img-title="Screenshot: {{ ss_log.employee_id }} at {{ ss_log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}">
                <div class="card-footer text-muted small text-center py-1">
                    {{ ss_log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if total_pages > 1 %}
    <nav aria-label="Screenshot Pagination" class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('reports.screenshot_report', employee_id=selected_employee_id, start_date=start_date_str, end_date=end_date_str, page=current_page-1) }}">«</a>
            </li>
            {% for p in range(1, total_pages + 1) %}
                <li class="page-item {% if p == current_page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('reports.screenshot_report', employee_id=selected_employee_id, start_date=start_date_str, end_date=end_date_str, page=p) }}">{{p}}</a>
                </li>
            {% endfor %}
            <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('reports.screenshot_report', employee_id=selected_employee_id, start_date=start_date_str, end_date=end_date_str, page=current_page+1) }}">»</a>
            </li>
        </ul>
    </nav>
    {% endif %}

    {% else %}
        <p class="text-center text-muted mt-4">No screenshots found for the selected criteria.</p>
    {% endif %}
{% else %}
    <p class="text-center text-muted mt-4">Please select an employee and date range to view their screenshots.</p>
{% endif %}

<!-- Modal for displaying larger screenshot -->
<div class="modal fade" id="screenshotModal" tabindex="-1" aria-labelledby="screenshotModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="screenshotModalLabel">Screenshot Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img src="" id="modalImage" class="img-fluid" alt="Enlarged Screenshot">
      </div>
      <div class="modal-footer">
         <p id="modalTitleParagraph" class="text-muted me-auto"></p>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts_extra %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('start_date_picker_ss')) {
        new Litepicker({ element: document.getElementById('start_date_picker_ss'), format: 'YYYY-MM-DD' });
    }
    if (document.getElementById('end_date_picker_ss')) {
        new Litepicker({ element: document.getElementById('end_date_picker_ss'), format: 'YYYY-MM-DD' });
    }

    var screenshotModalElement = document.getElementById('screenshotModal');
    if (screenshotModalElement) {
        screenshotModalElement.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var imgSrc = button.getAttribute('data-img-src');
            var imgTitle = button.getAttribute('data-img-title');
            var modalImage = screenshotModalElement.querySelector('#modalImage');
            var modalTitleParagraph = screenshotModalElement.querySelector('#modalTitleParagraph');

            modalImage.src = imgSrc;
            if(modalTitleParagraph) modalTitleParagraph.textContent = imgTitle;
        });
    }
});
</script>
{% endblock %}